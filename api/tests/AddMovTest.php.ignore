<?php
require_once __DIR__ . '/BaseTestCase.php';
require_once __DIR__ . '/../MovimentacaoController.php';

class AddMovTest extends BaseTestCase
{
    public static function setUpBeforeClass(): void
    {
        parent::setUpBeforeClass();

        self::$conn->exec("CREATE TABLE produtor (
            id_produtor INTEGER PRIMARY KEY AUTOINCREMENT,
            nome_produtor TEXT,
            email_produtor TEXT,
            hash_senha TEXT
        )");

        self::$conn->exec("CREATE TABLE hortas (
            id_hortas INTEGER PRIMARY KEY AUTOINCREMENT,
            produtor_id_produtor INTEGER,
            nome TEXT
        )");

        self::$conn->exec("CREATE TABLE produtos (
            id_produto INTEGER PRIMARY KEY AUTOINCREMENT,
            nm_produto TEXT,
            descricao TEXT,
            unidade_medida_padrao TEXT
        )");

        self::$conn->exec("CREATE TABLE estoques (
            id_estoques INTEGER PRIMARY KEY AUTOINCREMENT,
            hortas_id_hortas INTEGER,
            produto_id_produto INTEGER,
            ds_quantidade REAL,
            dt_plantio DATE,
            dt_colheita DATE
        )");

        self::$conn->exec("CREATE TABLE entradas_estoque (
            id_entrada INTEGER PRIMARY KEY AUTOINCREMENT,
            estoques_id_estoques INTEGER,
            produtor_id_produtor INTEGER,
            quantidade REAL,
            motivo TEXT,
            data_entrada DATETIME DEFAULT CURRENT_TIMESTAMP
        )");
    }

    protected function setUp(): void
    {
        self::$conn->beginTransaction();
    }

    protected function tearDown(): void
    {
        self::$conn->rollBack();
    }

    private function createProdutorAndHorta()
    {
        $stmt = self::$conn->prepare("INSERT INTO produtor (nome_produtor, email_produtor, hash_senha) VALUES ('Produtor Teste', 'teste@email.com', 'senha')");
        $stmt->execute();
        $id_produtor = self::$conn->lastInsertId();

        $stmt = self::$conn->prepare("INSERT INTO hortas (produtor_id_produtor, nome) VALUES (:id_produtor, 'Horta Teste')");
        $stmt->bindValue(':id_produtor', $id_produtor);
        $stmt->execute();

        return $id_produtor;
    }

    public function testAddMovSuccess()
    {
        $id_produtor = $this->createProdutorAndHorta();
        $input = [
            'nome_produto' => 'Tomate',
            'quantidade' => 10.5
        ];

        $controller = new MovimentacaoController(self::$conn);
        $response = $controller->addMov($input, $id_produtor);

        $this->assertEquals(200, $response['statusCode']);
        $this->assertEquals('sucesso', $response['body']['status']);
    }

    public function testAddMovInvalidData()
    {
        $id_produtor = $this->createProdutorAndHorta();
        $input = [
            'nome_produto' => '',
            'quantidade' => 10.5
        ];

        $controller = new MovimentacaoController(self::$conn);
        $response = $controller->addMov($input, $id_produtor);

        $this->assertEquals(400, $response['statusCode']);
        $this->assertEquals('erro', $response['body']['status']);
    }

    public function testAddMovNoHorta()
    {
        $id_produtor = $this->createProdutorAndHorta();
        self::$conn->exec("DELETE FROM hortas");

        $input = [
            'nome_produto' => 'Tomate',
            'quantidade' => 10.5
        ];

        $controller = new MovimentacaoController(self::$conn);
        $response = $controller->addMov($input, $id_produtor);

        $this->assertEquals(404, $response['statusCode']);
        $this->assertEquals('erro', $response['body']['status']);
    }

    public function testAddMovDatabaseError()
    {
        $id_produtor = $this->createProdutorAndHorta();
        self::$conn->exec("DROP TABLE produtos");
        $input = [
            'nome_produto' => 'Tomate',
            'quantidade' => 10.5
        ];

        $controller = new MovimentacaoController(self::$conn);
        $response = $controller->addMov($input, $id_produtor);

        $this->assertEquals(500, $response['statusCode']);
        $this->assertEquals('erro', $response['body']['status']);
    }
}
